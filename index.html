<!DOCTYPE html>
<html lang="en">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rishi's Protocol</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { 
            background-color: #020617; 
            color: #e2e8f0; 
            font-family: 'Courier New', Courier, monospace; 
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* Custom Animations */
        @keyframes slideUp { from { height: 0; opacity: 0; } to { height: var(--target-height); opacity: 1; } }
        .bar-anim { animation: slideUp 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        @keyframes pulse-glow { 0%, 100% { opacity: 1; filter: drop-shadow(0 0 5px currentColor); } 50% { opacity: 0.7; filter: drop-shadow(0 0 2px currentColor); } }
        .glow-text { animation: pulse-glow 3s infinite; }

        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .pop-anim { animation: pop 0.2s ease-in-out; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>

</head>
<body>
    
    <div id="root"></div>

    <script type="text/babel">

        const { useState, useEffect, useMemo, useRef } = React;


        // --- CONFIGURATION ---

        const PASSCODE = "2808";

        const MERCY_WINDOW_MINUTES = 15;


        // --- UTILS ---

        const getLocalDateString = (dateObj) => {

            const year = dateObj.getFullYear();

            const month = String(dateObj.getMonth() + 1).padStart(2, '0');

            const day = String(dateObj.getDate()).padStart(2, '0');

            return `${year}-${month}-${day}`;

        };


        const getCurrentTimeMinutes = () => {

            const now = new Date();

            return now.getHours() * 60 + now.getMinutes();

        };


        const parseTimeMinutes = (timeStr) => {

            const [h, m] = timeStr.split(':').map(Number);

            return h * 60 + m;

        };
        

        const formatMinutes = (mins) => {

            const h = Math.floor(mins / 60);

            const m = mins % 60;

            return h > 0 ? `${h}h ${m}m` : `${m}m`;

        };
        

        // Color Helpers

        const getCategoryColor = (cat) => {

            switch(cat) {

                case 'DSA': return 'text-emerald-500';

                case 'Academic': return 'text-blue-400';

                case 'Health': return 'text-rose-400';

                case 'Life': return 'text-amber-400';

                default: return 'text-slate-400';

            }

        };


        const getCategoryBg = (cat) => {

            switch(cat) {

                case 'DSA': return 'bg-emerald-500';

                case 'Academic': return 'bg-blue-500';

                case 'Health': return 'bg-rose-500';

                case 'Life': return 'bg-amber-500';

                default: return 'bg-slate-500';

            }

        };


        // --- AUDIO ENGINE ---

        const playSuccessSound = () => {

            try {

                const AudioContext = window.AudioContext || window.webkitAudioContext;

                if (!AudioContext) return;
                

                const ctx = new AudioContext();

                const osc = ctx.createOscillator();

                const gain = ctx.createGain();


                osc.connect(gain);

                gain.connect(ctx.destination);


                osc.type = 'sine';

                osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5

                osc.frequency.exponentialRampToValueAtTime(1046.5, ctx.currentTime + 0.1); // C6
                

                gain.gain.setValueAtTime(0.1, ctx.currentTime);

                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3);


                osc.start(ctx.currentTime);

                osc.stop(ctx.currentTime + 0.3);

            } catch (e) { console.error("Audio error", e); }

        };


        // --- CONFETTI ENGINE (Minimal) ---

        const triggerConfetti = () => {

            const colors = ['#10b981', '#3b82f6', '#f43f5e', '#f59e0b'];

            for (let i = 0; i < 30; i++) {

                const el = document.createElement('div');

                el.style.position = 'fixed';

                el.style.left = Math.random() * window.innerWidth + 'px';

                el.style.top = Math.random() * window.innerHeight + 'px';

                el.style.width = '6px';

                el.style.height = '6px';

                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

                el.style.pointerEvents = 'none';

                el.style.zIndex = '9999';

                document.body.appendChild(el);


                const angle = Math.random() * Math.PI * 2;

                const velocity = 2 + Math.random() * 2;

                const tx = Math.cos(angle) * 100 * velocity;

                const ty = Math.sin(angle) * 100 * velocity;


                el.animate([

                    { transform: 'translate(0, 0) scale(1)', opacity: 1 },

                    { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }

                ], {

                    duration: 800,

                    easing: 'cubic-bezier(0, .9, .57, 1)',

                }).onfinish = () => el.remove();

            }

        };


        // --- SCHEDULE DATA ---

        const SCHEDULES = {

            MON: [ // Ends 1:15 PM
                { time: "07:00", task: "Wake Up & Breakfast", cat: "Health", duration: 60 },
                { time: "08:00", task: "Commute (Audio/Music)", cat: "Life", duration: 45 },
                { time: "08:45", task: "Class: Linear Algebra (LAA)", cat: "Academic", duration: 60 },
                { time: "09:45", task: "Class: Microprocessors (MPCA)", cat: "Academic", duration: 60 },
                { time: "10:45", task: "Short Break", cat: "Life", duration: 30 },
                { time: "11:15", task: "Class: Computer Networks (CN)", cat: "Academic", duration: 120 },
                { time: "13:15", task: "Commute Home (Decompress)", cat: "Life", duration: 45 },
                { time: "14:00", task: "Lunch & Power Nap", cat: "Health", duration: 60 },
                { time: "15:00", task: "DSA Session 1", cat: "DSA", duration: 120 },
                { time: "17:00", task: "Evening Walk / Workout", cat: "Health", duration: 45 },
                { time: "17:45", task: "ISA Prep", cat: "Academic", duration: 90 },
                { time: "19:15", task: "Dinner & Family", cat: "Life", duration: 60 },
                { time: "20:15", task: "DSA Session 2", cat: "DSA", duration: 60 },
                { time: "21:15", task: "Buffer / Chill", cat: "Life", duration: 105 },
                { time: "23:00", task: "Sleep", cat: "Health", duration: 480 }
            ],

            TUE: [ // Lab Day (Ends 4:00 PM)
                { time: "07:00", task: "Wake Up & Breakfast", cat: "Health", duration: 60 },
                { time: "08:00", task: "Commute", cat: "Life", duration: 45 },
                { time: "08:45", task: "Class: Computer Networks (CN)", cat: "Academic", duration: 120 },
                { time: "10:45", task: "Short Break", cat: "Life", duration: 30 },
                { time: "11:15", task: "Class: Linear Algebra (LAA)", cat: "Academic", duration: 60 },
                { time: "12:15", task: "Class: Operating Systems (OS)", cat: "Academic", duration: 60 },
                { time: "13:15", task: "Lunch @ Campus", cat: "Health", duration: 45 },
                { time: "14:00", task: "LAB: MPCA (Microprocessors)", cat: "Academic", duration: 120 },
                { time: "16:00", task: "Commute Home (Drive)", cat: "Life", duration: 60 },
                { time: "17:00", task: "Rest & Eat (Recovery)", cat: "Health", duration: 60 },
                { time: "18:00", task: "DSA Session 1", cat: "DSA", duration: 90 },
                { time: "19:30", task: "Dinner", cat: "Life", duration: 60 },
                { time: "20:30", task: "ISA Prep", cat: "Academic", duration: 90 },
                { time: "22:00", task: "Wind Down", cat: "Life", duration: 60 },
                { time: "23:00", task: "Sleep", cat: "Health", duration: 480 }
            ],

            WED: [ // Ends 1:15 PM (Heavy DAA Day)
                { time: "07:00", task: "Wake Up & Breakfast", cat: "Health", duration: 60 },
                { time: "08:00", task: "Commute", cat: "Life", duration: 45 },
                { time: "08:45", task: "Class: DAA (Algorithms)", cat: "Academic", duration: 120 },
                { time: "10:45", task: "Short Break", cat: "Life", duration: 30 },
                { time: "11:15", task: "Class: Linear Algebra (LAA)", cat: "Academic", duration: 60 },
                { time: "12:15", task: "Class: Operating Systems (OS)", cat: "Academic", duration: 60 },
                { time: "13:15", task: "Commute Home", cat: "Life", duration: 45 },
                { time: "14:00", task: "Lunch & Nap", cat: "Health", duration: 60 },
                { time: "15:00", task: "DSA Session 1", cat: "DSA", duration: 90 },
                { time: "16:30", task: "ISA Prep", cat: "Academic", duration: 90 },
                { time: "18:00", task: "Break / Gym", cat: "Health", duration: 60 },
                { time: "19:00", task: "DSA Session 2", cat: "DSA", duration: 90 },
                { time: "20:30", task: "Dinner", cat: "Life", duration: 60 },
                { time: "21:30", task: "Light Reading / Buffer", cat: "Life", duration: 90 },
                { time: "23:00", task: "Sleep", cat: "Health", duration: 480 }
            ],

            THU: [ // Ends 1:15 PM
                { time: "07:00", task: "Wake Up & Breakfast", cat: "Health", duration: 60 },
                { time: "08:00", task: "Commute", cat: "Life", duration: 45 },
                { time: "08:45", task: "Class: MPCA", cat: "Academic", duration: 60 },
                { time: "09:45", task: "Class: DAA", cat: "Academic", duration: 60 },
                { time: "10:45", task: "Short Break", cat: "Life", duration: 30 },
                { time: "11:15", task: "Class: OS", cat: "Academic", duration: 60 },
                { time: "12:15", task: "Class: DAA (Double Algo Day)", cat: "Academic", duration: 60 },
                { time: "13:15", task: "Commute Home", cat: "Life", duration: 45 },
                { time: "14:00", task: "Lunch & Nap", cat: "Health", duration: 60 },
                { time: "15:00", task: "DSA Session 1", cat: "DSA", duration: 120 },
                { time: "17:00", task: "Break", cat: "Health", duration: 30 },
                { time: "17:30", task: "ISA Prep", cat: "Academic", duration: 90 },
                { time: "19:00", task: "Dinner", cat: "Life", duration: 60 },
                { time: "20:00", task: "DSA Session 2", cat: "DSA", duration: 60 },
                { time: "21:00", task: "Chill / Social", cat: "Life", duration: 120 },
                { time: "23:00", task: "Sleep", cat: "Health", duration: 480 }
            ],

            FRI: [ // Lab Day (Ends 4:00 PM)
                { time: "07:00", task: "Wake Up & Breakfast", cat: "Health", duration: 60 },
                { time: "08:00", task: "Commute", cat: "Life", duration: 45 },
                { time: "08:45", task: "Class: Linear Algebra (LAA)", cat: "Academic", duration: 60 },
                { time: "09:45", task: "Class: Operating Systems (OS)", cat: "Academic", duration: 60 },
                { time: "10:45", task: "Short Break", cat: "Life", duration: 30 },
                { time: "11:15", task: "Class: MPCA", cat: "Academic", duration: 120 },
                { time: "13:15", task: "Lunch @ Campus", cat: "Health", duration: 45 },
                { time: "14:00", task: "LAB: Computer Networks (CN)", cat: "Academic", duration: 120 },
                { time: "16:00", task: "Commute Home (Drive)", cat: "Life", duration: 60 },
                { time: "17:00", task: "Rest & Eat (Recovery)", cat: "Health", duration: 60 },
                { time: "18:00", task: "ISA Prep", cat: "Academic", duration: 90 },
                { time: "19:30", task: "Dinner", cat: "Life", duration: 60 },
                { time: "20:30", task: "Social / Movie / Fun", cat: "Life", duration: 210 },
                { time: "00:00", task: "Sleep", cat: "Health", duration: 420 }
            ],

            SAT: [ // Projects & Special Topics
                { time: "08:00", task: "Wake Up", cat: "Health", duration: 45 },
                { time: "08:45", task: "Experimental Learning / Projects", cat: "Academic", duration: 270 },
                { time: "13:15", task: "Lunch", cat: "Health", duration: 45 },
                { time: "14:00", task: "DSA Session 1", cat: "DSA", duration: 120 },
                { time: "16:00", task: "Project Work (Web Dev)", cat: "Academic", duration: 120 },
                { time: "18:00", task: "Social Night", cat: "Life", duration: 300 }
            ],

            SUN: [ // Reset Day
                { time: "09:00", task: "Wake Up & NGO Duty", cat: "Life", duration: 330 },
                { time: "14:30", task: "Lunch & Long Nap", cat: "Health", duration: 90 },
                { time: "16:00", task: "DSA Session 1", cat: "DSA", duration: 120 },
                { time: "18:00", task: "Weekly Plan & Laundry", cat: "Life", duration: 60 },
                { time: "19:00", task: "Casual Coding / Reading", cat: "Life", duration: 120 },
                { time: "21:00", task: "Early Sleep", cat: "Health", duration: 60 }
            ]

        };


        const getScheduleType = (date) => {
            const day = date.getDay(); 
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            return days[day];
        };

        // --- COMPONENT: STATUS CARD ---

        const StatusCard = ({ title, value, sub, color }) => (

            <div className={`p-4 rounded-xl border border-${color}-900/50 bg-${color}-950/20`}>

                <div className={`text-${color}-400 text-[10px] uppercase tracking-widest mb-1 font-bold`}>{title}</div>

                <div className="text-2xl font-bold text-white font-mono">{value}</div>

                <div className="text-xs text-slate-500 mt-1">{sub}</div>

            </div>

        );


        // --- COMPONENT: HEATMAP (GitHub Style) ---

        const Heatmap = ({ data }) => {

            // Generate last 28 days

            const days = Array.from({length: 28}, (_, i) => {

                const d = new Date();

                d.setDate(d.getDate() - (27 - i));

                return d;

            });


            return (

                <div className="flex gap-1 justify-between pt-4">

                    {days.map((d, i) => {

                        const dateStr = getLocalDateString(d);

                        const dayData = data[dateStr] || {};

                        const count = Object.values(dayData).filter(Boolean).length;

                        

                        // Color intensity based on tasks done

                        let bgClass = "bg-slate-800/50"; // Empty

                        if (count > 0) bgClass = "bg-emerald-900";

                        if (count > 2) bgClass = "bg-emerald-700";

                        if (count > 5) bgClass = "bg-emerald-500";

                        if (count > 8) bgClass = "bg-emerald-400";


                        const isToday = i === 27;


                        return (

                            <div key={i} className="group relative flex-1 flex flex-col items-center">

                                <div className={`w-full aspect-[4/5] rounded-sm ${bgClass} transition-all duration-300 ${isToday ? 'ring-1 ring-white' : ''}`}></div>

                                {/* Tooltip */}

                                <div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-600 px-2 py-1 rounded text-[9px] text-white opacity-0 group-hover:opacity-100 transition whitespace-nowrap z-20 pointer-events-none shadow-xl">

                                    {d.toLocaleDateString('en-US', {month:'short', day:'numeric'})}: {count} Done

                                </div>

                            </div>

                        );

                    })}

                </div>

            );

        };


        // --- COMPONENT: ACTIVE TASK CARD ---

        const ActiveTaskCard = ({ schedule, currentTime }) => {

            const currentTask = schedule.find(item => {

                const start = parseTimeMinutes(item.time);

                return currentTime >= start && currentTime < start + item.duration;

            });


            const nextTask = schedule.find(item => {

                return parseTimeMinutes(item.time) > currentTime;

            });


            if (!currentTask) {

                return (

                    <div className="glass-panel p-6 rounded-xl border-l-4 border-slate-500 flex flex-col items-center justify-center text-center h-32">

                        <div className="text-slate-400 text-sm font-bold">ALL CLEAR</div>

                        <div className="text-slate-600 text-xs mt-1">No active protocol task right now.</div>

                        {nextTask && <div className="text-xs text-slate-500 mt-2">Next: {nextTask.task} at {nextTask.time}</div>}

                    </div>

                );

            }


            const start = parseTimeMinutes(currentTask.time);

            const elapsed = currentTime - start;

            const remaining = currentTask.duration - elapsed;

            const progress = (elapsed / currentTask.duration) * 100;


            return (

                <div className="glass-panel p-6 rounded-xl border-l-4 border-indigo-500 relative overflow-hidden group">

                    <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">

                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>

                    </div>

                    

                    <div className="flex justify-between items-start mb-4 relative z-10">

                        <div>

                            <div className="text-indigo-400 text-[10px] uppercase tracking-widest font-bold mb-1 animate-pulse">

                                CURRENT OBJECTIVE

                            </div>

                            <h3 className="text-xl font-bold text-white leading-tight">{currentTask.task}</h3>

                        </div>

                        <div className="text-right">

                            <div className="text-2xl font-mono font-bold text-indigo-300">{remaining}m</div>

                            <div className="text-[10px] text-indigo-400/70">REMAINING</div>

                        </div>

                    </div>


                    {/* Progress Bar */}

                    <div className="w-full bg-slate-800/50 h-2 rounded-full overflow-hidden relative z-10">

                        <div 

                            className="bg-indigo-500 h-full transition-all duration-1000 ease-linear"

                            style={{ width: `${progress}%` }}

                        ></div>

                    </div>

                    

                    <div className="mt-2 flex justify-between text-[10px] text-slate-500 relative z-10">

                        <span>{currentTask.time}</span>

                        <span>{formatMinutes(currentTask.duration)} Block</span>

                        <span>{currentTask.cat}</span>

                    </div>

                </div>

            );

        };


        // --- COMPONENT: LOCK SCREEN ---

        const LockScreen = ({ onUnlock }) => {

            const [input, setInput] = useState("");

            const [shake, setShake] = useState(false);


            useEffect(() => {

                const handleKeyDown = (e) => {

                    if (e.key >= '0' && e.key <= '9') handlePress(e.key);

                    if (e.key === 'Backspace') setInput(prev => prev.slice(0, -1));

                };

                window.addEventListener('keydown', handleKeyDown);

                return () => window.removeEventListener('keydown', handleKeyDown);

            }, [input]);


            const handlePress = (num) => {

                if (input.length < 4) {

                    const newVal = input + num;

                    setInput(newVal);


                    if (newVal.length === 4) {

                        if (newVal === PASSCODE) onUnlock();

                        else { setShake(true); setTimeout(() => { setInput(""); setShake(false); }, 400); }

                    }

                }

            };


            return (

                <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-950 text-white relative overflow-hidden">

                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-slate-900 via-emerald-900 to-slate-900"></div>

                    <div className={`text-center mb-10 transition-transform ${shake ? 'translate-x-[-10px]' : ''}`}>

                        <h1 className="text-4xl font-bold tracking-[0.2em] text-white mb-2 font-mono">RISHI'S PROTOCOL</h1>

                        <p className="text-slate-600 text-[10px] uppercase tracking-[0.4em]">Secure Access Required</p>

                    </div>

                    <div className="flex gap-4 mb-10">

                        {[0,1,2,3].map(i => (<div key={i} className={`w-3 h-3 rounded-full transition-all duration-300 ${input.length > i ? 'bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]' : 'bg-slate-800'} ${shake ? 'bg-red-500' : ''}`} />))}

                    </div>

                    <div className="grid grid-cols-3 gap-6">

                        {[1,2,3,4,5,6,7,8,9].map(num => (<button key={num} onClick={() => handlePress(num.toString())} className="w-16 h-16 rounded-full bg-slate-900/50 border border-slate-800 text-xl font-mono hover:bg-slate-800 hover:border-emerald-500/50 hover:text-emerald-400 active:scale-95 transition-all duration-200 text-slate-300 shadow-lg">{num}</button>))}

                        <div className="col-start-2"><button onClick={() => handlePress("0")} className="w-16 h-16 rounded-full bg-slate-900/50 border border-slate-800 text-xl font-mono hover:bg-slate-800 hover:border-emerald-500/50 hover:text-emerald-400 active:scale-95 transition-all duration-200 text-slate-300 shadow-lg">0</button></div>

                    </div>

                </div>

            );

        };


        // --- COMPONENT: MAIN DASHBOARD ---

        const Dashboard = () => {


            // --- DATA LOADING & SYNC LOGIC ---

            const [data, setData] = useState({});

            const [isLoading, setIsLoading] = useState(true);

            

            const [currentTime, setCurrentTime] = useState(getCurrentTimeMinutes());

            const [selectedDate, setSelectedDate] = useState(() => {

                const d = new Date();

                // Defaults to showing tomorrow if it's late, but can adjust

                return d;

            });

            const [notifPerm, setNotifPerm] = useState(Notification.permission);

            const [focusMode, setFocusMode] = useState(false);


            // Clock

            useEffect(() => {

                const interval = setInterval(() => setCurrentTime(getCurrentTimeMinutes()), 60000); 

                return () => clearInterval(interval);

            }, []);


            // --- FETCH DATA FROM SERVER ON STARTUP ---

            useEffect(() => {

                const fetchData = async () => {

                    try {

                        // Ensure we call the API with the passcode

                        const response = await fetch(`/api/sync?passcode=${PASSCODE}`);

                        if (response.ok) {

                            const cloudData = await response.json();

                            setData(cloudData || {});

                        }

                    } catch (err) {

                        console.error("Failed to load data:", err);

                    } finally {

                        setIsLoading(false);

                    }

                };


                fetchData();

            }, []);


            const dateKey = getLocalDateString(selectedDate);

            const todayKey = getLocalDateString(new Date());

            const scheduleType = getScheduleType(selectedDate);

            const currentSchedule = SCHEDULES[scheduleType];


            // --- LOGIC ---

            const getTaskStatus = (taskIndex, taskTimeStr, isChecked) => {

                if (isChecked) return 'DONE';

                if (new Date(dateKey) > new Date(todayKey)) return 'PENDING'; // Future

                if (new Date(dateKey) < new Date(todayKey)) return 'MISSED'; // Past

                

                // Today

                const taskTime = parseTimeMinutes(taskTimeStr);

                const mercyLimit = taskTime + MERCY_WINDOW_MINUTES;

                if (currentTime < taskTime) return 'PENDING';

                if (currentTime >= taskTime && currentTime <= mercyLimit) return 'ACTIVE';

                return 'MISSED';

            };


            const toggleTask = async (idx, status) => {

                if (status === 'MISSED') {

                    alert("PROTOCOL VIOLATION: Time window expired. Task locked as FAILED.");

                    return;

                }

                

                // 1. Optimistic Update (Update Screen First)

                const dayData = data[dateKey] || {};

                const newState = !dayData[idx];

                const newData = { ...data, [dateKey]: { ...dayData, [idx]: newState } };

                

                setData(newData);


                if (newState) {

                    playSuccessSound();

                    triggerConfetti();

                }


                // 2. Sync to Backend (Send to Cloud)

                try {

                    await fetch('/api/sync', {

                        method: 'POST',

                        headers: { 'Content-Type': 'application/json' },

                        body: JSON.stringify({

                            passcode: PASSCODE,

                            data: newData

                        })

                    });

                } catch (err) {

                    console.error("Sync failed:", err);

                    // Optional: You could revert state here if sync fails

                }

            };


            const requestNotifs = () => {

                Notification.requestPermission().then(setNotifPerm);

            };


            // --- ANALYTICS ---

            const stats = useMemo(() => {

                const displayedTasks = SCHEDULES[getScheduleType(selectedDate)];

                const dayData = data[dateKey] || {};

                

                let missedCount = 0;

                let wastedMinutes = 0;

                let missedList = [];

                let completedList = [];

                let completedMinutes = 0;


                displayedTasks.forEach((item, idx) => {

                    const status = getTaskStatus(idx, item.time, dayData[idx]);

                    if (status === 'MISSED') {

                        missedCount++;

                        wastedMinutes += item.duration;

                        missedList.push(item);

                    } else if (status === 'DONE') {

                        completedList.push(item);

                        completedMinutes += item.duration;

                    }

                });


                return { missedCount, wastedMinutes, missedList, completedList, completedMinutes };

            }, [data, currentTime, selectedDate, dateKey]); 


            const changeDate = (days) => {

                const newDate = new Date(selectedDate);

                newDate.setDate(selectedDate.getDate() + days);

                setSelectedDate(newDate);

            };


            // --- RESET LOGIC (Clears Cloud DB) ---

            const resetAll = async () => {

                if(confirm("HARD RESET: Are you sure? This deletes ALL data permanently.")) {

                    // Send empty data to server

                    await fetch('/api/sync', {

                        method: 'POST',

                        headers: { 'Content-Type': 'application/json' },

                        body: JSON.stringify({

                            passcode: PASSCODE,

                            data: {} // Clear data

                        })

                    });

                    window.location.reload();

                }

            };


            if (isLoading) {

                return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-emerald-500 font-mono animate-pulse">CONNECTING TO SECURE SERVER...</div>;

            }


            return (

                <div className="min-h-screen bg-slate-950 p-4 md:p-8 font-mono pb-20 selection:bg-emerald-500/30">

                    

                    {/* TOP BAR */}

                    <div className="max-w-6xl mx-auto mb-10 border-b border-slate-800 pb-6 flex flex-col md:flex-row justify-between items-start md:items-center">

                        <div>

                            <h1 className="text-3xl font-bold text-white flex items-center gap-3">

                                <span className="text-emerald-500 text-4xl animate-pulse">❖</span> 

                                <span className="tracking-tight">RISHI'S PROTOCOL</span>

                            </h1>

                            <div className="flex items-center gap-2 mt-2">

                                <span className="px-2 py-0.5 rounded bg-emerald-950 border border-emerald-900 text-[10px] text-emerald-400 font-bold uppercase tracking-widest glow-text">

                                    GPA 10.0

                                </span>

                                <span className="text-slate-600 text-xs">//</span>

                                <span className="px-2 py-0.5 rounded bg-indigo-950 border border-indigo-900 text-[10px] text-indigo-400 font-bold uppercase tracking-widest glow-text">

                                    DSA MASTERY

                                </span>

                            </div>

                        </div>

                        

                        <div className="flex gap-4 mt-6 md:mt-0 items-center">

                            <button 

                                onClick={() => setFocusMode(!focusMode)} 

                                className={`px-3 py-2 text-[10px] border rounded transition uppercase tracking-widest flex items-center gap-2 ${

                                    focusMode ? 'bg-indigo-900 border-indigo-500 text-indigo-300' : 'text-slate-500 border-slate-800 hover:text-white'

                                }`}

                            >

                                {focusMode ? 'Exit Focus' : 'Focus Mode'}

                            </button>

                            {notifPerm !== 'granted' && (

                                <button onClick={requestNotifs} className="text-xs text-amber-500 hover:text-amber-400 underline">

                                    Enable Alerts

                                </button>

                            )}

                            <button onClick={resetAll} className="px-3 py-2 text-[10px] text-red-500 border border-red-900/50 rounded hover:bg-red-950 hover:text-red-400 transition uppercase tracking-widest">

                                System Reset

                            </button>

                        </div>

                    </div>


                    <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

                        

                        {/* LEFT: SCHEDULE */}

                        <div className={`lg:col-span-2 space-y-6 ${focusMode ? 'lg:col-span-3' : ''}`}>

                            

                            {/* ACTIVE TASK CARD (Always visible) */}

                            {dateKey === todayKey && (

                                <ActiveTaskCard schedule={currentSchedule} currentTime={currentTime} />

                            )}


                            {/* Navigation */}

                            <div className="glass-panel p-4 rounded-xl flex justify-between items-center bg-slate-900/40">

                                <button onClick={() => changeDate(-1)} className="p-2 hover:bg-slate-800 rounded text-slate-400">&larr;</button>

                                <div className="text-center">

                                    <h2 className="text-xl font-bold text-white">{selectedDate.toLocaleDateString('en-US', { weekday: 'long' })}</h2>

                                    <div className="text-xs text-slate-500 font-bold uppercase tracking-widest mt-0.5">{selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</div>

                                </div>

                                <button onClick={() => changeDate(1)} className="p-2 hover:bg-slate-800 rounded text-slate-400">&rarr;</button>

                            </div>


                            {/* Task List */}

                            <div className="glass-panel rounded-xl overflow-hidden border border-slate-800 shadow-2xl">

                                {currentSchedule.map((item, idx) => {

                                    const isChecked = (data[dateKey] && data[dateKey][idx]) || false;

                                    const status = getTaskStatus(idx, item.time, isChecked);

                                    

                                    // Visuals

                                    let rowClass = "border-b border-slate-800/50 transition-all duration-200";

                                    let textClass = "text-slate-300";

                                    

                                    // FIXED: Color logic for category text

                                    const catColor = getCategoryColor(item.cat);


                                    if (status === 'DONE') {

                                        rowClass += " bg-emerald-900/10";

                                        textClass = "text-emerald-500 line-through decoration-emerald-500/30";

                                    } else if (status === 'MISSED') {

                                        rowClass += " bg-red-950/20 grayscale opacity-50";

                                        textClass = "text-red-400 line-through decoration-red-500/50";

                                    } else if (status === 'ACTIVE') {

                                        rowClass += " bg-indigo-900/20 border-l-4 border-l-indigo-500";

                                        textClass = "text-white font-bold";

                                    }


                                    // Hide completed/future/missed tasks in Focus Mode

                                    if (focusMode && status !== 'ACTIVE') return null;


                                    return (

                                        <div key={idx} 

                                            onClick={() => toggleTask(idx, status)}

                                            className={`flex items-center p-4 ${rowClass} ${status !== 'MISSED' ? 'cursor-pointer hover:bg-slate-800/40' : 'cursor-not-allowed'}`}

                                        >

                                            <div className="w-16 text-slate-500 text-xs font-bold border-r border-slate-800 pr-4 mr-4 font-mono pt-1">

                                                {item.time}

                                            </div>

                                            

                                            <div className="flex-1">

                                                <div className={`text-sm font-medium transition-colors ${textClass}`}>

                                                    {item.task}

                                                </div>

                                                <div className="flex gap-2 mt-1">

                                                    {/* Category Badge */}

                                                    <span className={`text-[9px] uppercase tracking-wider font-bold ${catColor}`}>

                                                        {item.cat}

                                                    </span>

                                                    

                                                    {status === 'ACTIVE' && <span className="text-[9px] text-indigo-400 font-bold animate-pulse">WINDOW OPEN</span>}

                                                    {status === 'MISSED' && <span className="text-[9px] text-red-500 font-bold">LOCKED</span>}

                                                </div>

                                            </div>


                                            <div className={`w-6 h-6 rounded border flex items-center justify-center transition-all duration-300 

                                                ${isChecked ? 'bg-emerald-500 border-emerald-500 pop-anim' : 

                                                  status === 'MISSED' ? 'bg-red-900/20 border-red-900' : 

                                                  'border-slate-700 bg-slate-900'}`}>

                                                {isChecked && <span className="text-white text-xs font-bold">✓</span>}

                                                {!isChecked && status === 'MISSED' && <span className="text-red-500 text-xs font-bold">✕</span>}

                                            </div>

                                        </div>

                                    )

                                })}

                                {focusMode && currentSchedule.every(i => getTaskStatus(currentSchedule.indexOf(i), i.time, (data[dateKey]||{})[currentSchedule.indexOf(i)]) !== 'ACTIVE') && (

                                    <div className="p-8 text-center text-slate-500 italic">No active tasks right now. Relax.</div>

                                )}

                            </div>

                        </div>



                        {/* RIGHT: METRICS & LOGS (Hidden in Focus Mode) */}

                        {!focusMode && (

                            <div className="space-y-6">

                                

                                {/* GRAPH: HEATMAP */}

                                <div className="glass-panel p-6 rounded-xl">

                                    <h3 className="text-slate-400 text-[10px] uppercase tracking-[0.2em] mb-4 font-bold border-b border-slate-800 pb-2">

                                        Consistency Heatmap (28 Days)

                                    </h3>

                                    <Heatmap data={data} />

                                </div>


                                {/* VICTORY LOG */}

                                <div className="glass-panel p-6 rounded-xl border-t-4 border-emerald-500/50">

                                    <h3 className="text-emerald-400 text-[10px] uppercase tracking-[0.2em] mb-4 font-bold border-b border-slate-800 pb-2 flex items-center gap-2">

                                        <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>

                                        Battle Log (Victory)

                                    </h3>

                                    {stats.completedList.length === 0 ? (

                                        <div className="text-center py-4 text-slate-600 text-xs italic">No victories yet today.</div>

                                    ) : (

                                        <div className="space-y-2 max-h-40 overflow-y-auto">

                                            <div className="text-xs text-slate-400 mb-2">

                                                Secured <span className="text-white font-bold">{formatMinutes(stats.completedMinutes)}</span> of productive time.

                                            </div>

                                            {stats.completedList.map((item, i) => (

                                                <div key={i} className="flex justify-between items-center text-xs text-emerald-300/80 bg-emerald-900/10 p-1.5 rounded border border-emerald-900/30">

                                                    <span>{item.task}</span>

                                                    <span className="font-mono opacity-50">+{item.duration}m</span>

                                                </div>

                                            ))}

                                        </div>

                                    )}

                                </div>


                                {/* CASUALTY REPORT (FAILURES) */}

                                <div className="glass-panel p-6 rounded-xl border-t-4 border-red-500/50">

                                    <h3 className="text-red-400 text-[10px] uppercase tracking-[0.2em] mb-4 font-bold border-b border-slate-800 pb-2 flex items-center gap-2">

                                        <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>

                                        Casualty Report

                                    </h3>

                                    {stats.missedList.length === 0 ? (

                                        <div className="text-center py-4 text-slate-600 text-xs italic">Perimeter secure. No failures.</div>

                                    ) : (

                                        <div className="space-y-2 max-h-40 overflow-y-auto">

                                            <div className="text-xs text-slate-400 mb-2">

                                                Lost <span className="text-white font-bold">{formatMinutes(stats.wastedMinutes)}</span> forever.

                                            </div>

                                            {stats.missedList.map((item, i) => (

                                                <div key={i} className="flex justify-between items-center text-xs text-red-300/80 bg-red-900/10 p-1.5 rounded border border-red-900/30">

                                                    <span className="line-through decoration-red-500/50">{item.task}</span>

                                                    <span className="font-mono text-red-500">-{item.duration}m</span>

                                                </div>

                                            ))}

                                        </div>

                                    )}

                                </div>


                            </div>

                        )}

                    </div>

                </div>

            );

        };



        const App = () => {

            const [isLocked, setIsLocked] = useState(true);

            return isLocked ? <LockScreen onUnlock={() => setIsLocked(false)} /> : <Dashboard />;

        };


        const root = ReactDOM.createRoot(document.getElementById('root'));

        root.render(<App />);


    </script>
</body>
</html>
